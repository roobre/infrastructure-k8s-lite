name: Publish

on:
  push:
    branches: [ master ]
  schedule:
    - cron: "0 3 * * *"

jobs:
  publish-latest:
    name: Build & publish latest
    runs-on: ubuntu-latest
    env:
      IMAGE: roobre/infrastructure-k8s-lite:latest
    steps:
      - uses: actions/checkout@v2
      - uses: docker/login-action@v1
        with:
          username: roobre
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build docker image
        run: |
          docker build . -t $IMAGE
      - name: Upload docker images
        run: |
          docker push $IMAGE

  publish-master:
    name: Build & publish master from sources
    runs-on: ubuntu-latest
    env:
      IMAGE: roobre/infrastructure-k8s-lite:master
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: '1.16'
      - name: Clone upstream repo
        run: |
          git clone https://github.com/newrelic/nri-kubernetes
      - uses: docker/login-action@v1
        with:
          username: roobre
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Patch and build upstream master
        working-directory: nri-kubernetes
        env:
          GOOS: linux
          GOARCH: amd64
        run: |
          sed -i "s/interval: 15/interval: 30/" nri-kubernetes-definition.yml
          go mod download
          make compile
          docker build . --squash -t $IMAGE
          docker build . --squash -t $IMAGE-unprivileged --build-arg 'MODE=unprivileged'
      - name: Upload docker images
        run: |
          docker push $IMAGE
          docker push $IMAGE-unprivileged
